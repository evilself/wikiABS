<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
      start-state="registerForm">

    <!-- secured attributes="ROLE_USER" /-->    
    
    <var name="user" class="com.americanbanksystems.wiki.domain.User"/>
    
    <view-state id="registerForm" model="user">		
        <transition on="step1" to="registerAction"/>        
    </view-state>
    
    <action-state id="registerAction">
		<!-- evaluate expression="entityGenerator.returnSuccess()"/-->
		<evaluate expression="entityGenerator.checkUsernameAvailability(user)"/>		 
		<transition on="success" to="accountUserDetailsForm"/>
		<transition on="failure" to="registerFormError"/>
	</action-state>
    
    <view-state id="registerFormError" view="registerForm.jsp" model="user">
    	<binder>
	        <binding property="userName" required="true" />	        
    	</binder>
    	<on-entry>
			<set name="flowScope.error" value="'ERROR'"/>
		</on-entry>
        <transition on="step1" to="registerAction"/>        
    </view-state>
    
    <view-state id="accountUserDetailsForm" model="user">
        <transition on="step2" to="registerAccount"/>        
    </view-state>
    
   <action-state id="registerAccount">
		<!-- evaluate expression="entityGenerator.returnSuccess()"/-->
		<evaluate expression="entityGenerator.registerUser(user)"/>		 
		<transition on="success" to="securityQuestionForm"/>
		<transition on="failure" to="registerFormError"/>
	</action-state>
	
	<view-state id="securityQuestionForm" model="user">
        <transition on="step3" to="completeRegistration"/>        
    </view-state>

</flow>
        